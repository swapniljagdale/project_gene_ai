# Source-to-Target Mapping: `preprocess_lnd_participant_daily.py`

## 1. Overview
This document provides a detailed column-level source-to-target mapping for the `preprocess_lnd_participant_daily.py` script. The script's purpose is to perform an incremental load of daily participant data into the landing layer, ensuring data integrity and preventing duplicates.

## 2. Business & ETL Rules
The following rules govern the transformation process:

*   **Incremental Loading**: The process is designed to be incremental. It only adds new records from the daily source feed to the existing data snapshot.
*   **Duplicate Record Prevention**: The primary business rule is to avoid duplicate entries. A record is considered a duplicate if it has the same `participant_id` and `event_id` as a record already present in the landing table snapshot.
*   **Identifying New Records**: To enforce the no-duplication rule, the ETL performs a `left_anti` join between the daily preprocessed data and the existing snapshot. This operation effectively filters the daily data, retaining only the records that are new.
*   **Data Combination**: The final target table is generated by performing a `union` between the new records (from the daily feed) and all the records from the original snapshot.
*   **Schema Consistency**: The script assumes that the schema of the daily preprocessed data is consistent with the schema of the landing table snapshot. The `unionByName` operation relies on this consistency.
*   **Data Validation (Implied)**: The script defines a list of `non_null_columns` (`participant_id`, `event_id`, `hcp_id`). This implies a business rule that these fields must not be empty, and a data quality check may be performed.

## 3. Column-Level Mapping

The following table details the mapping for each column from the source tables to the final target landing table.

| Target Column | Source Table(s) | Source Column(s) | Transformation Logic & Business Rule |
| :--- | :--- | :--- | :--- |
| `participant_id` | `preprocess_df`, `snapshot_df` | `participant_id` | **Direct Mapping.** This column is part of the composite key used in the `left_anti` join to identify new records. The value is taken directly from the source. |
| `event_id` | `preprocess_df`, `snapshot_df` | `event_id` | **Direct Mapping.** This column is part of the composite key used in the `left_anti` join to identify new records. The value is taken directly from the source. |
| `hcp_id` | `preprocess_df`, `snapshot_df` | `hcp_id` | **Direct Mapping.** The value is taken directly from the source. This is an implied non-null column. |
| `(All other columns)` | `preprocess_df`, `snapshot_df` | `(Matching column name)` | **Direct Mapping.** All other columns are mapped directly from source to target via the `unionByName` operation. The logic ensures that for a given record, its data comes either from the new daily feed (if it's a new record) or the existing snapshot (if it's an old record). |
